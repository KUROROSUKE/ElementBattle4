let p1_hand=[],p2_hand=[],p1_point=0,p2_point=0,p1_selected_card=[],p2_selected_card=[];const card_num=8;let WIN_POINT=250,WIN_TURN=10,dropped_cards_p1=[],dropped_cards_p2=[],turn="p1",time="game",numTurn=1,p1_is_acting=!1;const elementToNumber={H:1,He:2,Li:3,Be:4,B:5,C:6,N:7,O:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,S:16,Cl:17,Ar:18,K:19,Ca:20,Fe:26,Cu:29,Zn:30,I:53},elements=[...Array(6).fill("H"),...[,,,,].fill("O"),...[,,,,].fill("C"),"He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"],element=["H","O","C","He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"];let deck=[...elements,...elements],materials=[],imageCache={};async function loadMaterials(){let e=await fetch("../compound/obs_standard_min.json"),t=await e.json();return t.material&&Array.isArray(t.material)?t.material:[]}async function view_p2_hand(){let e=document.getElementById("p2_hand");p2_hand.forEach((t,n)=>{let a=document.createElement("img");a.src=imageCache[elementToNumber[t]].src,a.alt=t,a.style.padding="5px",a.style.border="1px solid #000",a.classList.add("selected"),a.addEventListener("click",function(){let e=document.getElementById("ron_button");if(e.style.display="none","make"==time&&(this.classList.toggle("selected"),this.classList.contains("selected")?(this.style.border="1px solid #000",this.style.padding="5px",p2_selected_card.splice(p2_selected_card.indexOf(this.alt),1)):(this.style.border="5px solid #F00",this.style.padding="1px",p2_selected_card.push(this.alt))),"p2"==turn&&"game"==time){dropped_cards_p2.push(this.alt);let t=document.createElement("img");t.alt=this.alt,t.src=imageCache[elementToNumber[this.alt]].src,t.style.border="1px solid #000",document.getElementById("dropped_area_p2").appendChild(t),this.classList.remove("selected"),this.classList.add("selected");let a=drawCard();this.src=imageCache[elementToNumber[a]].src,this.alt=a,this.style.padding="5px",this.style.border="1px solid #000",p2_hand[n]=a,turn="p1",setTimeout(()=>{p1_action()},500)}}),e.appendChild(a)})}async function view_p1_hand(){let e=document.getElementById("p1_hand");p1_hand.forEach((t,n)=>{let a=document.createElement("img");a.src=imageCache[0].src,a.alt="相手の手札",a.style.padding="5px",a.style.border="1px solid #000",a.classList.add("selected"),e.appendChild(a)})}async function search(e){return materials.find(t=>{for(let n in e)if(!t.components[n]||t.components[n]!==e[n])return!1;for(let a in t.components)if(!e[a])return!1;return!0})||materials[0]}async function p1_make(){let e=await search_materials(arrayToObj(p1_hand));return e&&0!==e.length?(e.sort((e,t)=>t.point-e.point),e):[{name:"なし",formula:"なし",point:0,components:{},advantageous:[],number:0}]}async function p2_make(){document.getElementById("generate_button").style.display="none";let e=document.getElementById("done_button");e.style.display="inline",e.replaceWith(e.cloneNode(!0));let t=document.getElementById("done_button");return new Promise(e=>{t.addEventListener("click",function(){let t=search(arrayToObj(p2_selected_card));e(t)})})}async function get_dora(){return element[Math.round(23*Math.random())]}async function done(e,t=!1){let n=await p2_make(),a=await p1_make();dora=await get_dora(),console.log(`ドラ: ${dora}`);let l=n.point,i=a[0].point;Boolean(n.advantageous.includes(a[0].formula))?l*=1.5+Math.random()/2:Boolean(a[0].advantageous.includes(n.formula))&&(i*=1.5+Math.random()/2),Boolean(Object.keys(n.components).includes(dora))?l*=1.5:Boolean(Object.keys(a[0].components).includes(dora))&&(i*=1.5),t&&("p2"==e?l/=1.2:i/=1.2),"p2"==e?i/=1.5:l/=1.5,l=Math.round(l),p1_point+=await (i=Math.round(i)),p2_point+=await l,document.getElementById("p2_point").innerHTML+=`+${l}`,document.getElementById("p1_point").innerHTML+=`+${i}`,document.getElementById("p2_explain").innerHTML=`生成物質：${n.name}, 組成式：${n.formula}`,document.getElementById("p1_explain").innerHTML=`生成物質：${a[0].name}, 組成式：${a[0].formula}`;let d=await win_check();document.getElementById("done_button").style.display="none";let r=document.getElementById("nextButton");r.style.display="inline",d?(console.log("ゲーム終了"),r.textContent="ラウンド終了",r.addEventListener("click",function(){returnToStartScreen(),p1_point=0,p2_point=0,numTurn=0,resetGame(),r.style.display="none";let e=r.cloneNode(!0);r.parentNode.replaceChild(e,r)})):(console.log("次のゲーム"),numTurn+=1,r.textContent="次のゲーム",r.addEventListener("click",function(){resetGame(),r.style.display="none";let e=r.cloneNode(!0);r.parentNode.replaceChild(e,r)}))}async function win_check(){return Math.abs(p1_point-p2_point)>=WIN_POINT?p1_point>p2_point?"p1":"p2":numTurn>=WIN_TURN?p1_point>p2_point?"p1":"p2":null}async function p1_exchange(e){dropped_cards_p1.push(p1_hand[e]);var t=p1_hand[e];if(!p1_hand[e]){console.error("Invalid target element in p1_hand.");return}let n=document.createElement("img");n.src=imageCache[elementToNumber[p1_hand[e]]].src,n.style.border="1px solid #000",document.getElementById("dropped_area_p1").appendChild(n);let a=document.querySelectorAll("#p1_hand img")[e];if(!a){console.error("Image element not found in p1_hand.");return}let l=drawCard();p1_hand[e]=l,a.src=imageCache[0].src,a.alt=l,a.style.padding="5px",a.style.border="1px solid #000",a.classList.remove("selected"),a.classList.add("selected"),turn="p2",checkRon(t)}async function p1_action(){if("p1"!==turn||p1_is_acting)return;p1_is_acting=!0;let e=materials.filter(e=>e.point>50),t=e.sort((e,t)=>{let n=Object.keys(e.components).reduce((t,n)=>t+Math.min(p1_hand.filter(e=>e===n).length,e.components[n]),0);return Object.keys(t.components).reduce((e,n)=>e+Math.min(p1_hand.filter(e=>e===n).length,t.components[n]),0)-n||t.point-e.point}),n=t[0];if(n){let a=!0;for(let l in n.components)if(!p1_hand.includes(l)||p1_hand.filter(e=>e===l).length<n.components[l]){a=!1;break}if(a&&n.point>50)time="make",await done("p1");else{let i=p1_hand.filter(e=>!(e in n.components)||p1_hand.filter(t=>t===e).length>n.components[e]);if(i.length>0){let d=i[Math.floor(Math.random()*i.length)];p1_exchange(p1_hand.indexOf(d))}else time="make",done("p1")}}else p1_exchange(Math.floor(Math.random()*p1_hand.length));turn="p2",p1_is_acting=!1}function arrayToObj(e){let t={};return e.forEach(e=>{t[e]?t[e]++:t[e]=1}),t}function shuffle(e){let t=e.length;for(;0!=t;){let n=Math.floor(Math.random()*t);t--,[e[t],e[n]]=[e[n],e[t]]}return e}function drawCard(){return deck.length>0?deck.pop():(time="make",done("no-draw"))}async function search_materials(e){return materials.filter(t=>{for(let n in t.components)if(!e[n]||t.components[n]>e[n])return!1;return!0})}function random_hand(){for(let e=0;e<8;e++)p1_hand.push(drawCard()),p2_hand.push(drawCard())}function resetGame(){p1_hand=[],p2_hand=[],dropped_cards_p1=[],dropped_cards_p2=[],p1_selected_card=[],p2_selected_card=[],time="game",turn=.5>=Math.random()?"p1":"p2",numTurn=1,document.getElementById("p1_point").innerHTML=`ポイント：${p1_point}`,document.getElementById("p1_explain").innerHTML="　",document.getElementById("p2_point").innerHTML=`ポイント：${p2_point}`,document.getElementById("p2_explain").innerHTML="　",document.getElementById("generate_button").style.display="inline",document.getElementById("done_button").style.display="none",document.getElementById("nextButton").style.display="none",deck=shuffle(deck=[...elements,...elements]);let e=document.getElementById("p1_hand"),t=document.getElementById("p2_hand");e.innerHTML="",t.innerHTML="";let n=document.getElementById("dropped_area_p1"),a=document.getElementById("dropped_area_p2");n.innerHTML="",a.innerHTML="",random_hand(),view_p1_hand(),view_p2_hand(),"p1"===turn&&setTimeout(()=>p1_action(),500)}function preloadImages(){[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,26,29,30,53].forEach(e=>{let t=new Image;t.src=`../images/${e}.webp`,imageCache[e]=t})}async function init_json(){materials=await loadMaterials()}async function checkRon(e){let t=await search_materials(arrayToObj([...p2_hand,e])),n=t.filter(t=>t.components[e]);if(n.length>0){let a=document.getElementById("ron_button");a.style.display="inline",a.replaceWith(a.cloneNode(!0));let l=document.getElementById("ron_button");l.addEventListener("click",function(){l.style.display="none",p2_selected_card=[e],time="make";let t=document.getElementById("dropped_area_p1").children,n=t[t.length-1];n.style.border="2px solid f00",done("p2",!0)})}let i=await search_materials(arrayToObj([...p1_hand,e])),d=i.filter(t=>t.point>=70&&t.components[e]);d.length>0&&(p1_hand.push(e),p1_selected_card=[e],time="make",done("p1",!0))}function updateGeneratedMaterials(e){if(!e||"なし"===e)return;let t=JSON.parse(localStorage.getItem("generatedMaterials"))||{};t[e]?t[e]+=1:t[e]=1,localStorage.setItem("generatedMaterials",JSON.stringify(t))}function openWinSettings(){document.getElementById("winSettingsModal").style.display="block"}function saveWinSettings(){let e=parseInt(document.getElementById("winPointInput").value,10),t=parseInt(document.getElementById("winTurnInput").value,10);if(isNaN(e)||e<1){alert("WIN_POINT は 1 以上の数値を入力してください。");return}if(isNaN(e)||e>999){alert("WIN_POINT の最大値は 999 です。");return}if(isNaN(t)||t<1){alert("WIN_TURN は 1 以上の数値を入力してください。");return}WIN_POINT=e,WIN_TURN=t,closeWinSettings()}function closeWinSettings(){document.getElementById("winSettingsModal").style.display="none"}async function findMostPointMaterial(){let e=await search_materials(arrayToObj(p2_hand));if(0===e.length)console.log("p2_hand 内で作成可能な物質はありません。");else{let t=e.reduce((e,t)=>t.point>e.point?t:e,e[0]);console.log(`p2_hand 内で最もポイントが高い物質: ${t.name} (ポイント: ${t.point})`)}}function returnToStartScreen(){document.getElementById("startScreen").style.display="flex",document.getElementById("p1_area").style.display="none",document.getElementById("dropped_area_p1").style.display="none",document.getElementById("dropped_area_p2").style.display="none",document.getElementById("p2_area").style.display="none",document.getElementById("gameRuleButton").style.display="block"}function showRules(){document.getElementById("rulesModal").style.display="block"}function closeRules(){document.getElementById("rulesModal").style.display="none"}document.getElementById("generate_button").addEventListener("click",function(){if("p2"==turn){time="make";let e=document.getElementById("ron_button");e.style.display="none",done("p2")}}),document.getElementById("setting_icon").addEventListener("click",function(){document.getElementById("winSettingsModal").style.display="inline"}),document.addEventListener("DOMContentLoaded",function(){preloadImages(),init_json(),deck=shuffle(deck=[...elements,...elements]),random_hand(),view_p1_hand(),view_p2_hand(),"p1"==(turn=Math.random()>=.5?"p1":"p2")&&p1_action()}),document.getElementById("startButton").addEventListener("click",function(){document.getElementById("startScreen").style.display="none",document.getElementById("p1_area").style.display="block",document.getElementById("dropped_area_p1").style.display="block",document.getElementById("dropped_area_p2").style.display="block",document.getElementById("p2_area").style.display="block",document.getElementById("gameRuleButton").style.display="none"}),document.getElementById("closeRulesButton").addEventListener("click",closeRules),window.onclick=function(e){let t=document.getElementById("rulesModal");e.target===t&&closeRules()};